#!/bin/sh -e

export DESTDIR="$1"

patch -p1 < rootless_modesetting.patch

# Merged upstream
# https://gitlab.freedesktop.org/xorg/xserver/-/merge_requests/955
patch -p1 < muon.patch

# Disable tests.
: > test/meson.build

muon setup \
    -Dwarning_level=2 \
    -Dprefix=/usr \
    -Dlocalstatedir=/var \
    -Dsystemd_logind=false \
    -Dglx=true \
    -Ddri1=true \
    -Ddri2=true \
    -Ddri3=true \
    -Dglamor=true \
    -Dxorg=true \
    -Dxephyr=false \
    -Dxdmcp=false \
    -Ddefault_font_path=/usr/share/fonts \
    -Dsecure-rpc=false \
    output

ninja -C output
muon  -C output install
